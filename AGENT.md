# Flashcards‑v3 — AI Agent Guide

> **Назначение файла**: это инструкция для ИИ‑помощников (ChatGPT/Claude и др.), которые помогают
> писать и править код/документацию в этом репозитории. Следуй правилам ниже, чтобы не ломать
> архитектурные инварианты и соответствовать ТЗ/планам.

---

## 0) Каноничные источники (читать в таком порядке)

1. **TRS**: `doc/trs/trs_v_5.md` — _источник истины_ по функционалу, нефункциональным требованиям и
   критериям приёмки.
2. **Roadmap**: `doc/roadmap/roadmap.md` — вехи и зависимости.
3. **Планы этапов**: `doc/plan/plan_1.md … plan_5.md` — что входит в текущий этап.
4. **Best Practices** (`doc/best_practices/`):
   - `TechnicalGuidesForClaudeAPIv2.0.md` — **приоритетный** гайд по Claude API (после официальной
     документации Anthropic).
   - `Message Batches.md`, `MessageBatches2.md` — как использовать и парсить batches.
   - `best_practices0.md`, `best_practices1.md` — современные практики React/TS/Node 2025.

5. **README** — обзор репозитория и структуру папок.

> Любая правка кода **должна ссылаться** на соответствующие пункты TRS/плана (номер раздела/этапа) в
> описании PR.

---

## 1) Архитектурные инварианты (не нарушать)

- **Манифест как источник истины**: порядок и состав предложений фиксирует Manifest (SID). LV‑текст
  собирается **только** из манифеста (§4 TRS).
- **Агрегация по SID**: все ответы LLM/JSONL агрегируются исключительно по `SID`, порядок строк
  JSONL **не значим**.
- **FSM → UI**: состояние UI — проекция конечной автомата; никаких «спонтанных» setState.
- **JSON‑только**: все LLM‑ответы — строго структурированный JSON; гибриды с текстом запрещены (если
  не указано иначе в плане).
- **Config‑first**: **никаких хардкодов** (модель, тайминги, лимиты, хоткеи, стили, размеры, языки).
  Всё из `config/*.json(.*)` со схемами Zod (§3, §16 TRS).
- **i18n/Theming**: все строки UI из `/src/locales/*`; темы через токены/vars.
- **Безопасность ключей**: ключи провайдеров — только на **proxy**; фронт не хранит секреты.

---

## 2) Техстек и режимы

- **Node.js** v24.6.0 (ESM), **npm** v11.5.1.
- **Frontend**: React 18, TS, Vite, Tailwind, Framer Motion.
- **Proxy**: Express/Fastify (ESM), маршруты: `/api/health`, `/api/llm/single`,
  `/api/batch/{create,status,result}`.
- **Режимы**: Text → Flashcards → Reading → Translation → Edit.

Подробности см. §5 TRS. Хоткеи Flashcards, подсказки Reading (delay/debounce/cancel/single‑flight),
статистика Translation, Edit с master‑visible/правкой контекстов — обязательны.

### Поток данных (КРИТИЧНО для понимания)

```
Исходный текст → Сплиттер → Манифест {sid, lv, sig} → LLM по чанкам
                                   ↑
LV из манифеста ← Агрегация по SID ← Валидация DTO ← JSONL ответы
RU/target по SID ← Каноникализация ←
```

## 2A) Build & Commands

- Проверка типов: `npm run type-check`
- Запуск тестов: `npm run test`
- Золотые тесты: `npm run test:golden`
- Property-based тесты: `npm run test:property`
- Покрытие тестов: `npm run test:coverage`
- Dev сервер: `npm run dev`
- Сборка: `npm run build`
- Валидация конфигов/схем: `npm run validate:config`
- Генерация индекса конфигов: `npm run docs:config`
- Общая валидация (линт+тесты): `npm run validate`

---

## 3) Batch‑режим и ошибки (UI‑первая диагностика)

- Перед любым стартом/загрузкой — **pre‑flight** `/api/health`; при down прокси/нет сети →
  **немедленный баннер**.
- **Polling** фронта с адаптивным интервалом; proxy уважает `Retry‑After` при опросе Anthropic
  (§7–§8 TRS).
- Обрабатываем и **показываем**: `429`, `413`, `500`, `529`, истёкшие batch‑результаты. Консольные
  логи **не** заменяют баннеры.
- Конфигурация лимитов/ретраев в `config/batch.json`, при конфликте гайдов ориентироваться на
  `doc/best_practices/TechnicalGuidesForClaudeAPIv2.0.md`.

---

## 4) Reading: подсказки, контекстное меню, reveal‑on‑peek

- **Tooltip‑производительность**: `tooltip.showDelayMs` (по умолчанию 0; можно 3000), `debounceMs`,
  `cancelOnLeave=true`, **single‑flight**; до истечения порога **не выполнять** запросы.
- **Приоритет фраз** над словами при пересечении. Позиционирование в пределах viewport; на мобильных
  — bottom‑sheet/popover.
- **Контекстное меню** (ПКМ/long‑press): конфиги в `config/actions.json`; плейсхолдеры
  `%w/%p/%b/%s/%sel/%lv/%tl`; белый список доменов.
- **Reveal‑on‑peek**: по успешному показу подсказки карточка становится `visible=true`; в Reading
  остаётся подсветка `peeked` (конфиг стили). Ручная правка видимости в Edit имеет приоритет.

---

## 5) Edit: видимость, правки переводов, Restore

- **VISIBLE** чекбокс и **Master Visible** — синхронно влияют на Flashcards/Reading/Translation.
- Разрешена правка **базового перевода** и **переводов контекстов**; **мгновенная пропагация** в
  другие режимы.
- «Править контексты (N)» открывает таблицу/модал; удаление карточки удаляет связанные подсказки.
- **Restore**: откат к состоянию «после первичной обработки», опционально `Undo` (если включён
  бэкап). В `reveal‑on‑peek` сбрасывает видимость и `peeked`.

---

## 6) Import/Export

- **JSON**: полный снапшот состояния (включая пользовательские правки, видимость,
  i18n/targetLanguage, policy); экспорт → ре‑импорт должен давать **идентичное** состояние.
- **JSONL** (Anthropic Console): потоковый парсер, агрегация по `custom_id==SID`, порядок строк не
  важен; отчёт об ошибках. Можно импортировать даже по истечении 29 дней (офлайн‑результат).
- Стратегии слияния: `replace-all | merge-keep-local | merge-prefer-imported` (дефолт — из конфига
  `io.import.defaultMerge`).

---

## 7) Конфиги и документация (обязательно)

- Все пользовательские параметры — в `/config/` и документируются в `doc/configs/*.md` **на
  русском** (назначение, ключи, дефолты, примеры, зависимые ключи, changelog, владелец).
- Валидация: Zod/JSON Schema на старте (`npm run validate:config`), **fail‑fast** при ошибках.
- Генерация индекса: `npm run docs:config`.
- Анти‑хардкод линт и скрипт `npm run lint:anti-hardcode` (в CI).

---

## 8) Стандарты кода и тесты

- **TypeScript**: strict + `exactOptionalPropertyTypes` + `noUncheckedIndexedAccess`.
- **Иммутабельность** состояний; явные инварианты/ассерты.
- **Зод‑схемы** на всех границах (proxy↔client, LLM↔proxy, import/export).
- **Линт‑вывод**: `eslint-formatter-codeframe` (подсветка контекста ошибок).
- **Тесты**: unit + integration + **E2E (Cypress)**. Добавлять золотые тесты на порядок предложений
  и property‑based тесты на инварианты.

### Code Style для AI‑агентов

- **Функциональный стиль** предпочтителен, избегать скрытых побочных эффектов.
- **Immutable**‑обновления через spread/структурное клонирование.
- **Explicit инварианты**: `assert()`/`invariant()` + runtime проверки на ключевых путях.
- **Комментарии на русском** для бизнес‑логики; **английские термины** — только для техконцепций.

#### Именование

- Компоненты: `PascalCase` (например, `TextInput`, `BatchRunner`).
- Функции/переменные: `camelCase` (например, `buildManifest`, `aggregateBySid`).
- Константы: `SCREAMING_SNAKE_CASE` (например, `BATCH_STATES`).
- Типы: `PascalCase` (при необходимости префикс `T`).

### Метрики мониторинга

- `schema_mismatch_count` — несоответствия версий схем.
- `sig_mismatch_count` — несовпадения сигнатур SID.
- `missing_ru_count` — отсутствующие переводы/целевой язык.
- `order_violation_count` — нарушения порядка предложений.

Полезные команды

```bash
npm run dev
npm run build
npm run lint -- --format codeframe
npm run test && npm run e2e
npm run validate:config && npm run docs:config
```

---

## 9) Как ИИ‑агент вносит изменения (процесс)

1. Определи релиз и этап: см. `doc/plan/plan_X.md`. Не добавляй фичи из будущих этапов без явного
   флага.
2. Сверь требования: найди соответствующие разделы в TRS и Acceptance.
3. Найди **конфиги**: проверь наличие ключей; если нет — предложи схему Zod + RU‑док.
4. Измени код модульно: адаптеры/сторы/компоненты. Исключи хардкоды.
5. Добавь/обнови тесты (unit/E2E) и ключи i18n.
6. Обнови документацию: указать изменённые ключи, ссылки на TRS/план.
7. В PR: краткая сводка «что/зачем/ссылки на § TRS», чек‑лист DoD из соответствующего плана.

---

## 10) Модули и карта ответственности

- `src/types/` — доменные типы/DTO.
- `src/utils/manifest.ts` — создание/валидация манифеста.
- `src/utils/aggregator.ts` — агрегация по SID/JSONL.
- `src/utils/fsm.ts` — машина состояний batch‑процесса.
- `src/api/client.ts` — HTTP‑клиент с Zod‑валидацией.
- `src/hooks/*` — бизнес‑логика (tooltip controller, batch polling, visibility policy).
- `src/components/*` — UI (Flashcards/Reading/Translation/Edit, Import/Export и пр.).

---

## 11) Чек‑лист «не повторять ошибки»

- ☐ **Race conditions** при сборке переводов (использовать single‑flight, мемоизацию, сторы).
- ☐ Источник порядка — **только** Manifest; не собирать LV/RU из карточек «с конца».
- ☐ FSM переходы — детерминированы, без циклов.
- ☐ Все DTO валидируются, версии схем согласованы; метрики `schema_mismatch_count`,
  `order_violation_count` не растут.
- ☐ Баннеры ошибок: выводятся сразу; консоль — вторично.
- ☐ Строки UI и стили — из конфигов/локалей, не из кода.

## 12) Мысленная модель (для ИИ‑агента)

1. **Манифест первый** — всегда начинай с манифеста и SID.
2. **SID как ключ** — вся агрегация/сборка по SID.
3. **FSM определяет UI** — состояние UI = проекция FSM.
4. **Инварианты = безопасность** — любое изменение проверяется тестами/асертами.

### Процесс принятия решений

- Сохраняет ли изменение детерминированность обработки?
- Не нарушает ли архитектурные инварианты?
- Покрыто ли изменение нужными тестами (в т.ч. golden/property‑based)?
- Совместимо ли с FSM и агрегацией по SID?

### Debugging подход

1. Проверить состояние FSM. 2) Валидация манифеста (SID/sig). 3) Проследить агрегацию по SID. 4)
   Проверить DTO‑схемы и версии.

## 13) Ссылки по проекту

- TRS: `doc/trs/trs_v_5.md`
- Roadmap: `doc/roadmap/roadmap.md`
- Планы этапов: `doc/plan/plan_1.md … plan_5.md`
- Best Practices: `doc/best_practices/*`
- README: `README.md`

> Любые расхождения между кодом и TRS/планами нужно указывать в PR и предлагать правку
> соответствующего документа.
