# Сессия 14 — S4 Message Batches API (50% cost savings)

**Дата:** 2026-01-03 **Агент:** Claude Opus 4.5 **Branch:** `main` **Tag:** `S4-1`

---

## Что сделано

### 1. Реализован официальный Anthropic Message Batches API

**Проблема:**

- Текущая "batch" реализация была синхронным циклом по Messages API
- Не использовался официальный Message Batches API (50% экономия, async processing)
- Это было отмечено как CRITICAL в doc/STATUS.md

**Решение:**

#### Server (`server/src/services/messageBatches.ts`)

- Полная интеграция с `@anthropic-ai/sdk`
- Функции: `createBatch`, `getBatch`, `getBatchResults`, `cancelBatch`, `listBatches`
- Логирование всех операций с префиксом `[MessageBatches]`

#### Server routes (`server/src/index.ts`)

- `POST /claude/batches` — создание батча с prompt caching
- `GET /claude/batches` — список батчей
- `GET /claude/batches/:batchId` — статус и результаты
- `POST /claude/batches/:batchId/cancel` — отмена батча
- `DELETE /claude/batches/:batchId` — удаление батча

#### Prompt Caching

- System prompt и tool definitions включают `cache_control: { type: 'ephemeral' }`
- Дополнительная экономия помимо 50% от Message Batches

### 2. Клиентская часть

#### API Client (`src/api/client.ts`)

- Новые типы: `MessageBatch`, `MessageBatchResult`
- Методы: `createMessageBatch`, `getMessageBatch`, `listMessageBatches`, `cancelMessageBatch`

#### Hook (`src/hooks/useMessageBatches.ts`)

- Состояние: `currentBatch`, `isProcessing`, `isComplete`, `isFailed`, `error`, `progress`
- Действия: `submitBatch`, `cancelBatch`, `reset`
- Адаптивный polling с учётом реального времени обработки
- Извлечение flashcards из batch results
- Логирование cache hits

#### Store (`src/stores/batchHistoryStore.ts`)

- Zustand store с persistence
- История последних 10 батчей
- Статусы: pending, in_progress, canceling, ended

### 3. UI (`src/components/Text/TextStub.tsx`)

- **Processing Mode selector:**
  - Single (direct API)
  - Mock Batch (local)
  - **Message Batches (50% off)** — NEW

- **Current Batch panel:**
  - Batch ID
  - Status badge (Processing/Completed/Canceling)
  - Progress: X/Y succeeded, Z errors

- **Batch History panel:**
  - Last 10 batches
  - Status badges
  - Cancel button for active batches

### 4. Локализация

- Добавлены i18n ключи в `en.json` и `ru.json`:
  - `errors.quota_exhausted`
  - `errors.batch_processing`
  - `batch.status.*`

### 5. E2E тесты (Playwright)

Обновлён `pw-e2e/tooluse.spec.ts`:

- 8 тестов для всех режимов
- UI тесты для Message Batches mode
- Реальное ожидание завершения батчей (до 10 минут)
- Все 16 E2E тестов проходят (5.2 минуты)

---

## Новые файлы/модули

```
server/src/services/messageBatches.ts   — Message Batches service
src/hooks/useMessageBatches.ts          — React hook для Message Batches
src/stores/batchHistoryStore.ts         — Zustand store для истории батчей
```

## Изменённые файлы

```
server/package.json                     — добавлен @anthropic-ai/sdk
server/src/index.ts                     — маршруты /claude/batches/*
src/api/client.ts                       — API методы для Message Batches
src/components/Text/TextStub.tsx        — новый UI с режимами
src/hooks/useErrorBanners.tsx           — новые error codes
src/locales/en.json, ru.json            — новые ключи
pw-e2e/tooluse.spec.ts                  — обновлённые E2E тесты
playwright.config.ts                    — таймаут 11 минут для batch тестов
```

---

## Проблемы и решения

### 1. Type error с exactOptionalPropertyTypes

**Проблема:** `endedAt: string | undefined` несовместимо с `string`

**Решение:** Условный spread: `...(batch.endedAt && { endedAt: batch.endedAt })`

### 2. Node.js версия

**Проблема:** Vite 7.3.0 требует Node.js 20.19+

**Решение:** `nvm use 22` (v22.21.1)

### 3. Playwright selectors

**Проблема:** Multiple elements matching `/Status:.*complete/i`

**Решение:** `.first()` или точное совпадение `'Status: complete'`

---

## Текущий статус

### S4 — В процессе (Message Batches API: 100%)

**Завершено:**

- ✅ Message Batches API (официальный Anthropic API)
- ✅ Prompt caching с cache_control
- ✅ UI с 3 режимами обработки
- ✅ Batch history (last 10)
- ✅ E2E тесты

**Не завершено (на S4-2):**

- ❌ Reading v1: подсветка слов/фраз
- ❌ Tooltip (delay/debounce/cancel/single-flight)
- ❌ Позиционирование в viewport

---

## TODO на следующую сессию (S4-2)

### Reading v1

1. **Подсветка слов/фраз**
   - Приоритет: фраза побеждает при пересечении
   - Разные стили для слов vs фраз
   - Легенда

2. **Tooltip**
   - `showDelayMs` (0..3000) из конфигов
   - `debounceMs`, `cancelOnLeave`
   - **single-flight** — один запрос в полёте
   - Позиционирование в viewport

3. **Mobile**
   - Popover/bottom-sheet вместо tooltip

---

## Метрики сессии

- **Files changed:** 14
- **Lines added:** ~1634
- **Lines removed:** ~102
- **New modules:** 3
- **Tests:** 16/16 E2E passing (5.2 min)
- **Type check:** ✅ passing

---

## Ключевые команды

```bash
# Запуск dev сервера
npm run dev:full

# E2E тесты
npx playwright test pw-e2e/tooluse.spec.ts

# Type check
npm run type-check

# Переключение Node.js
nvm use 22
```

---

## Обновление документации

В ходе сессии обновлена документация:

1. **doc/STATUS.md** — S4-1 помечен как DONE, S4-2 как TODO
2. **doc/roadmap/roadmap.md** — S3 ✅, S4 active, status snapshot обновлён
3. **doc/glossary/glossary.md** — новая секция Message Batches API + термины
4. **AGENT.md** — добавлены ссылки на новые файлы Message Batches
5. **README.md** — расширенный Repository layout, App modes, Quick start
6. **src/hooks/AGENT.md** — добавлен `useMessageBatches` (2.5)

---

**Итог:** Реализован официальный Anthropic Message Batches API с 50% экономией. Добавлен prompt
caching. UI показывает выбор режима, статус батча, историю. Все тесты проходят. Документация
обновлена. S4 разделён на S4-1 (Message Batches) и S4-2 (Reading v1).
