# Сессия 13 — S3 Flashcards v1 (100%)

**Дата:** 2026-01-02 **Агент:** Claude Opus 4.5 **Branch:** `main` (продолжение после merge S3)

---

## Что сделано

### 1. Исправлен race condition в useBatchPipeline

**Проблема:**

- Submit button ничего не делал (no logs, no API calls)
- Два useEffect конфликтовали: useBatch dispatch RESET vs useBatchPipeline auto-start
- Оба effects запускались в одном render cycle, auto-start видел stale state

**Решение:**

- Заменён `startedFor` ref на `pendingStartRef` для отслеживания какой batch запускать
- Auto-start effect теперь ждёт пока FSM станет idle после INIT
- Добавлен новый FSM action `INIT` для правильной инициализации с корректными totalSids/totalChunks

**Файлы:**

- `src/hooks/useBatch.ts` — pendingStartRef логика
- `src/utils/fsm.ts` — INIT action

### 2. Подключены batch результаты к FlashcardsView

**Проблема:**

- Tool-use (single) вызывал `setCards(cards)`, но batch — нет
- После batch completion карточки не отображались

**Решение:**

- Добавлен useEffect в TextStub для связи batchResult.cards с FlashcardsView

**Файл:** `src/components/Text/TextStub.tsx`

### 3. Исправлен CORS на сервере

**Проблема:**

- CORS блокировал запросы с разных localhost портов

**Решение:**

- CORS config теперь разрешает любой `localhost` origin

**Файл:** `server/src/index.ts`

### 4. Добавлен base_translation в prompts

**Проблема:**

- Обратная сторона карточки показывала "—" вместо перевода

**Решение:**

- Обновлены system prompts для требования `base_translation`
- Добавлен `base_translation` в required array tool schema

**Файл:** `server/src/index.ts`

### 5. Зафиксирован CRITICAL GAP: Message Batches API

**Обнаружено:**

- Текущая "batch" реализация — синхронный цикл по Messages API
- НЕ реализован официальный Claude Message Batches API (50% экономия, async, JSONL)
- TRS §7 требует официальный API

**Действие:**

- Зафиксировано в `doc/STATUS.md` и `doc/roadmap/roadmap.md`
- Решено закрыть в S4 вместе с Reading v1

### 6. Верификация S3 Definition of Done

**Все критерии выполнены:**

| Критерий                               | Статус |
| -------------------------------------- | ------ |
| Карточки front/back + flip-анимация    | ✅     |
| Контексты N по умолчанию, expand до M  | ✅     |
| Хоткеи ←/→/Space/↑/↓/h                 | ✅     |
| Подсветка форм в контекстах            | ✅     |
| Сброс flip на front при навигации      | ✅     |
| `h` скрывает карточку (visible: false) | ✅     |
| Стили/шрифт из конфигов                | ✅     |
| Dark theme поддержка                   | ✅     |
| Unit + E2E тесты                       | ✅     |

---

## Проблемы и решения

### Проблема 1: Race condition в useEffect hooks

**Симптомы:**

- Submit button не работал
- Console.log в начале submit не выводился

**Причина:**

- useBatch dispatch RESET и useBatchPipeline auto-start запускались одновременно
- Auto-start читал stale fsmState.batchState

**Решение:**

- `pendingStartRef` для отслеживания pending batch
- Effect ждёт `fsmState.batchState === 'idle'` перед стартом

### Проблема 2: FSM не инициализировался с правильными counts

**Симптомы:**

- После RESET totalSids=0, totalChunks=0

**Причина:**

- RESET использовал createInitialBatchState() без параметров

**Решение:**

- Новый action INIT с payload `{ totalSids, totalChunks }`

### Проблема 3: Node.js версия

**Симптомы:**

- Vite 7.3.0 требует Node.js 20.19+
- WSL имел 20.18.0

**Решение:**

- Upgrade через nvm до v22.21.1

### Проблема 4: Rollup module not found

**Симптомы:**

- `Cannot find module @rollup/rollup-linux-x64-gnu`

**Решение:**

- `rm -rf node_modules package-lock.json && npm install`

---

## Текущий статус

### S3 — 100% ✅

**Завершено:**

- ✅ Zustand store (`flashcardsStore.ts`)
- ✅ useFlashcards hook (headless)
- ✅ useHotkeys hook (config-driven)
- ✅ highlightForm utility
- ✅ FlashcardsView UI (Card, CardFace, Navigation)
- ✅ CSS 3D flip animation
- ✅ Dark theme support
- ✅ Integration с batch pipeline
- ✅ Unit tests (flashcardsStore, useHotkeys, highlightForm)
- ✅ E2E tests (flashcards.spec.ts)
- ✅ All 114 unit tests passing
- ✅ All 10 E2E tests passing

---

## TODO на следующую сессию (S4)

### S4 — Reading v1 + Message Batches API

1. **Message Batches API** (CRITICAL)
   - Реализовать официальный Anthropic Message Batches API
   - 50% экономия, async processing, JSONL format
   - См. TRS §7, `doc/best_practices/Message Batches.md`

2. **Reading v1**
   - Подсветка слов (A) и фраз (B)
   - Tooltip с delay/debounce/cancel/single-flight
   - Позиционирование в viewport
   - Mobile popover/bottom-sheet

---

## Метрики сессии

- **Files modified:** 10
- **Lines added:** ~315
- **Lines removed:** ~229
- **Bugs fixed:** 4 (race condition, FSM init, CORS, base_translation)
- **Critical gaps documented:** 1 (Message Batches API)
- **Tests:** 114 unit + 10 E2E passing

---

## Ключевые файлы

```
src/hooks/useBatch.ts                  — Race condition fix (pendingStartRef)
src/utils/fsm.ts                       — INIT action
src/components/Text/TextStub.tsx       — Batch→FlashcardsView connection
server/src/index.ts                    — CORS fix, base_translation prompt
doc/STATUS.md                          — Critical gap documented
doc/roadmap/roadmap.md                 — S4 scope updated
pw-e2e/flashcards.spec.ts              — E2E tests updated
pw-e2e/tooluse.spec.ts                 — E2E tests updated
```

---

**Итог:** S3 Flashcards v1 завершён на 100%. Все функции реализованы, тесты проходят. Выявлен и
задокументирован critical gap (Message Batches API) — запланирован на S4.
