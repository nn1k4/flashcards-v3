# План реализации — Этап 2 (v1.1)

Связка с ТЗ: TRS v5.0 (§6, §9, §10, §15, §19; «v1.1: JSONL импорт; Restore/Undo; контекстное меню;
reveal‑on‑peek»).

## 0) Цели этапа

- Добавить **импорт JSONL** (офлайн‑результаты из Anthropic Console) с превью изменений и
  стратегиями слияния.
- Реализовать **Restore/Undo** в Edit (откат ко входному состоянию с локальным бэкапом).
- Добавить **контекстное меню** в Reading (ПКМ/long‑press) с конфигурируемыми действиями и белым
  списком доменов.
- Включить альтернативную политику видимости **reveal‑on‑peek** (карточки становятся видимыми после
  подсказки).
- Закрыть качество: тесты, доки, конфиги, отсутствие хардкодов.

Не входят: OCR/PDF/Images/Subtitles, Media follow-highlight, профили/подписки (это v1.2+).

---

## 1) Рабочие пакеты

### 1.1 Импорт JSONL (Anthropic batches)

- [ ] **Схемы**: `src/config/schemas/io.ts` — добавить `import.allowed=["json","jsonl"]`,
      `io.import.maxFileSizeMB`.
- [ ] **Парсер** `src/io/jsonl.ts`:
  - Читает файл как stream/строки; каждая строка → JSON; извлекает `custom_id==SID` и `result`.
  - Агрегация по SID; валидация структуры данных (Zod).
  - Отчёт: imported / skipped / invalid (с причинами).
- [ ] **Превью**: модал «Импорт JSONL» — diff по ключам state (новые карточки/контексты, изменения
      переводов/видимости).
- [ ] **Стратегии**: `replace-all | merge-keep-local | merge-prefer-imported` (дефолт берём из
      `io.import.defaultMerge`).
- [ ] **Ошибки/UX**: баннер при превышении `maxFileSizeMB`, неверном типе, поломанной строке;
      локализованные тексты.
- [ ] **E2E**: импорт валидного JSONL → состояние обновлено; импорт с ошибками → корректный отчёт,
      валидные записи загружены.

### 1.2 Restore/Undo в Edit

- [ ] **Модель бэкапа**: `BackupStore` (ring‑buffer) с ttl из конфига
      (`io.restore.makeBackupBefore=true`).
- [ ] **Кнопка Restore** в Edit (рядом с Add New Card):
  - Показывает сводку: сколько карточек/контекстов будет затронуто.
  - Откатывает: все пользовательские правки переводов/контекстов; добавленные карточки — удаляет;
    удалённые — восстанавливает.
  - Видимость: сброс по политике (см. 1.4).
- [ ] **Undo** (toast/баннер) доступен N минут (конфиг) — «Вернуть изменения» возвращает последний
      бэкап.
- [ ] **Unit/E2E**: сценарии Restore/Undo, корректный откат/возврат, интеграция с
      Flashcards/Reading/Translation.

### 1.3 Контекстное меню в Reading (ПКМ/long‑press)

- [ ] **Конфиг** `config/actions.json` + Zod‑схема `actions.schema.ts`:
  - Пункты: id, enabled, type(`search|clipboard`), `titleKey`, `urlTemplate|payload`, `target`,
    `security.allowedHosts`.
  - Плейсхолдеры и кодирование: `%w,%p,%b,%s,%sel,%lv,%tl` (URI‑encoding).
- [ ] **Компонент** `ContextMenu`:
  - Триггеры: `contextmenu` (desktop), `long‑press` (mobile); якорится к спану; не выходит за экран.
  - Открывает ссылки в `_blank` с `rel="noopener noreferrer"`; фильтрует домены по `allowedHosts`.
  - i18n‑заголовки пунктов.
- [ ] **UX‑согласование** с tooltip: меню не перекрывает всплывашку; задержка подсказки не блокирует
      меню.
- [ ] **Тесты**: unit (сборка URL, фильтр доменов, подстановка плейсхолдеров); e2e (ПКМ/long‑press).

### 1.4 Политика видимости `reveal‑on‑peek`

- [ ] **Конфиг** `flashcards.visibilityPolicy` = `reveal-on-peek`.
- [ ] **Механизм**: при показе подсказки (после `tooltip.showDelayMs`) эмитим
      `CARD_VISIBILITY_CHANGED(visible=true)`, отмечаем `peeked`.
- [ ] **Persistence**: сохраняем `peeked` и `visible` в локальном сторе/экспорте; в Edit ручная
      правка имеет приоритет.
- [ ] **UI**: постоянная подсветка peeked (стиль из `flashcards.peekHighlight`).
- [ ] **Тесты**: e2e — скрытые до подсказки; подсказка делает карточку видимой; Edit позволяет
      массово менять видимость.

### 1.5 Документация/линт/доп.квалити

- [ ] RU‑доки: `/docs/configs/io.md`, `/docs/configs/actions.md`, обновление `flashcards.md` (peek
      policy).
- [ ] Дополнение в **AGENT.md/Codex.md**: правила для JSONL парсера, меню действий и reveal‑on‑peek.
- [ ] Анти‑хардкод: паттерны для URL‑шаблонов, кодов ошибок, хоткеев.

---

## 2) Спринты

### S9 — JSONL Import

- Схемы/конфиги, парсер JSONL, превью диффа, стратегии merge, e2e.

### S10 — Restore/Undo

- BackupStore, UX‑сводка, откат/undo, интеграционные тесты.

### S11 — Reading Context Menu

- Конфиг действий, компонент меню, плейсхолдеры, безопасность, unit+e2e.

### S12 — Reveal‑on‑Peek

- События подсказок → видимость, подсветка peeked, персист/экспорт, тесты.

### S13 — Docs & Polish

- Доки конфигов, доработка AGENT/Codex, анти‑хардкод проверки.

---

## 3) DoD (Definition of Done)

- Импорт JSONL: валидные строки загружаются; отчёт по пропущенным; merge‑стратегии работают;
  ре‑экспорт→ре‑импорт сохраняет состояние.
- Restore/Undo: откатывает к входному состоянию, Undo возвращает изменения; совместимость с
  политикой видимости.
- Контекстное меню: ПКМ/long‑press, корректные URL, домены из белого списка; i18n заголовки; не
  конфликтует с tooltip.
- Reveal‑on‑peek: карточки становятся видимыми после подсказок; подсветка `peeked` присутствует;
  Edit имеет приоритет.
- Документация/линт: обновлены RU‑доки; нет хардкодов; все тесты зелёные.

---

## 4) Риски и меры

- **Большие JSONL**: потоковый парсер и ограничение размера (`maxFileSizeMB`), прогресс-индикатор.
- **Права и безопасность**: `allowedHosts` + строгая подстановка плейсхолдеров.
- **Состояние видимости**: чёткая сериализация в экспорт и восстановление при импорте.
- **UX Restore**: ясная сводка изменений и обязательный бэкап (Undo).
