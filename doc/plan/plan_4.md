# План реализации — Этап 4 (v1.3: Media follow‑highlight + Export Anki/Quizlet)

Связка с ТЗ: TRS v5.0 — §22 «Медиасинхронизация», §19.2 «Экспорт Anki/Quizlet», §16 «Конфиги»,
§17–§18 (приёмка/тесты), §20 «План релизов (v1.3)».

## 0) Цели этапа

- Добавить **медиасинхронизацию**: воспроизведение видео/аудио, подсветка текущей единицы в Reading
  (follow‑highlight), управление хоткеями.
- Интегрировать **переход от текста к медиасегменту** (и обратно), в т.ч. pre/post‑roll, плавный
  скролл.
- Реализовать **экспорт колод в форматы Anki/Quizlet** (первая итерация — текстовые форматы для
  импорта).
- Соблюдать конфиг‑first (медиа/экспорт), i18n, доступность, mobile‑friendliness.

Не входят: YouTube‑капшены (v2.0), TTS автогенерация для карточек (вне этапа).

---

## 1) Рабочие пакеты

### 1.1 Media Core (PlayerAdapter)

- [ ] **Интерфейс** `PlayerAdapter`:
  ```ts
  interface MediaRef {
    id: string;
    type: 'audio' | 'video';
    src: string;
    duration?: number;
    meta?: Record<string, unknown>;
  }
  interface MediaAnchor {
    sid: string;
    offsetStart: number;
    offsetEnd: number;
    confidence?: number;
  }
  interface PlayerAdapter {
    mount(el: HTMLElement, ref: MediaRef): Promise<void>;
    play(): void;
    pause(): void;
    seek(ms: number): void;
    currentTime(): number;
    on(event: 'timeupdate' | 'ended' | 'error', cb: (t: number) => void): void;
    destroy(): void;
  }
  ```
- [ ] **HTML5 реализация**: `<audio>/<video>`; поддержка HLS/DASH (если в конфиге
      `provider: 'html5'`).
- [ ] **События**: `timeupdate` → диспетчер подсветки; `error` → баннер с деталями.
- [ ] **Конфиг** `media.json`: `preRollMs`, `postRollMs`, `hotkeys`
      (playPause/backMs/forwardMs/prevSentence/nextSentence), `provider`, `debounceMs` подсветки.

### 1.2 Anchors & Follow‑Highlight

- [ ] Хранилище `MediaAnchorsStore` (SID→{start,end}).
- [ ] Маппинг на Reading: подсветка **активной** фразы/слова по текущему времени; плавный скролл к
      видимой области.
- [ ] **Функции перехода**:
  - из Reading: клик по слову/фразе → `playSegment(SID, pre/post‑roll)`;
  - из плеера: выбрать текущую фразу/слово по ближайшему SID.
- [ ] Настройки перформанса: `throttle/debounce` обновления подсветки, отключение на слабых
      устройствах (конфиг).

### 1.3 Управление (горячие клавиши/мобильные жесты)

- [ ] Хоткеи: из `media.hotkeys` (Space — play/pause; ←/→ — back/forward на `N` мс; ↑/↓ — prev/next
      sentence). Конфигурируемо.
- [ ] Мобильные жесты: тап по бокам — ±N секунд; двойной тап — play/pause.
- [ ] ARIA/доступность: кнопки управления доступны с клавиатуры; проговариваемые метки.

### 1.4 Экспорт Anki/Quizlet (v1)

- [ ] **Конфиг** `io.export.formats=["json","anki","quizlet"]` + параметры (`anki.deck`,
      `anki.contextDelimiter`, `quizlet.delimiter`, `quizlet.quote`).
- [ ] **Маппинг полей**:
  - Front: латышская форма (слово/фраза);
  - Back: перевод + первые N контекстов с переводами (N — из `flashcards.contextsDefault` или
    отдельного ключа экспорта).
  - Доп. колонки: base_form, unit, примечания (опц.).
- [ ] **Форматы**:
  - **Anki**: TSV/CSV, совместимый с импортом колоды (апгрейд до .apkg — отдельной задачей вне
    v1.3);
  - **Quizlet**: CSV/TSV согласно конфигу (разделитель/кавычки), экранирование.
- [ ] **Локализация**: заголовки/подписи/подсказки экспорта.
- [ ] **Тесты**: unit — экранирование, построение строк, срез контекстов; E2E — экспорт, импорт в
      тестовый профиль Anki/Quizlet (ручная проверка + авто скриншоты).

### 1.5 UX/Интеграция

- [ ] Раздел Media в UI: плеер (mini/inline), кнопки переходов, индикатор активного SID.
- [ ] В Reading: иконки «▶ сегмент», «⤴ к медиамоменту» рядом с подсказкой/фразой.
- [ ] В Flashcards: на обороте — ссылка «воспроизвести контекст» (если есть якоря).
- [ ] Экспорт: пункт в верхнем меню; диалог выбора формата и параметров (N контекстов на Back,
      включать ли base_form и т.д.).

### 1.6 Документация/Конфиги/Качество

- [ ] RU‑док: `/docs/configs/media.md`, `/docs/configs/io.export.md`.
- [ ] Обновить AGENT.md/Codex.md — правила для PlayerAdapter и экспортёров.
- [ ] Анти‑хардкод: задержки, хоткеи, разделители — только из конфигов.

---

## 2) Спринты

### S20 — Media Core

- PlayerAdapter (HTML5), события, конфиг, базовая панель управления.

### S21 — Anchors & Follow‑Highlight

- Store якорей, подсветка по времени, переходы Text↔Media, перформанс‑тюнинг.

### S22 — Управление и UX

- Хоткеи/жесты, доступность, интеграция в Reading/Flashcards.

### S23 — Экспорт Anki/Quizlet

- Маппинг, формирование файлов, диалог, тесты, ручная проверка импорта.

### S24 — Документация и полировка

- RU‑доки, конфиги, E2E сценарии, стабилизация.

---

## 3) Definition of Done (DoD)

- Плеер запускается и корректно управляется (play/pause/seek/back/forward); ошибки воспроизведения
  показывают локализованные баннеры.
- Follow‑highlight: текущая фраза/слово подсвечивается в Reading; клик по тексту играет
  соответствующий сегмент с pre/post‑roll.
- Хоткеи/жесты работают и конфигурируются; доступны с клавиатуры.
- Экспорт Anki/Quizlet создаёт корректные файлы (экранирование, кодировка, количество контекстов);
  импорт в целевые сервисы успешен.
- Нет хардкодов; конфиги валидируются; тесты зелёные.

---

## 4) Риски и меры

- **Неточные тайминги**: допуски/nearest SID; ручная корректировка якорей (в будущем); pre/post‑roll
  смягчает несоответствие.
- **Проигрывание на мобильных**: ограничения автоплея → только по пользовательскому действию;
  fallback UI.
- **Совместимость Anki/Quizlet**: различия форматов → строгая документация, экспорт в универсальные
  CSV/TSV на v1.3, .apkg позже.
- **Производительность подсветки**: throttle/debounce, отключаемый follow‑highlight в конфиге.
