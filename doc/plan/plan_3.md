# План реализации — Этап 3 (v1.2: Ingestion — PDF/OCR/Images/Subtitles)

Связка с ТЗ: TRS v5.0 — §21 «Источники текста и импорт контента», §4 (pipeline), §16 (конфиги),
§17–§18 (приёмка/тесты), §20 «План релизов (v1.2)».

## 0) Цели этапа

- Добавить источники текста, помимо ручной вставки: **PDF → текст/или OCR**, **изображения/скриншоты
  (включая Clipboard) → OCR**, **субтитры (SRT/VTT/ASS)**.
- Обеспечить единообразный **Manifest (SID)** на выходе всех адаптеров.
- Сделать UI дружелюбным: drag&drop, прогресс, ошибки, mobile‑first, ленивые модули.
- Соблюдать **конфиг‑first** и Zod‑валидацию, без хардкодов. Локализация UI.

Не входят: медиаплеер и follow‑highlight (это v1.3), YouTube‑капшены (v2.0), профили/подписки
(v2.0).

---

## 1) Рабочие пакеты

### 1.1 Архитектура Ingestion

- [ ] **IngestionManager**: единая точка входа, выбирает адаптер по MIME/расширению/источнику.
- [ ] **Общий интерфейс адаптера**:
  ```ts
  interface IngestResult {
    manifest: Manifest;
    meta: Record<string, unknown>;
    warnings?: string[];
  }
  interface IngestAdapter {
    canHandle(input: Input): boolean;
    ingest(input: Input, cfg: Cfg): Promise<IngestResult>;
  }
  ```
- [ ] **Ленивая подгрузка**: `PdfAdapter`, `OcrAdapter` (tesseract/wasm), `ImageAdapter`,
      `SubtitleAdapter`, `ClipboardAdapter` — динамические чанки.
- [ ] **Web Worker** для OCR/тяжёлых парсеров.
- [ ] **Конфиги**: `ingestion/pdf.json`, `ingestion/ocr.json`, `ingestion/images.json`,
      `ingestion/subtitles.json` + схемы Zod.

### 1.2 PDF

- [ ] Детект текста: если есть текстовый слой → извлекаем как plain‑text; иначе **fallback на OCR**.
- [ ] Лимиты: `maxPages`, `maxFileSizeMB`, `supportedMime` (конфиг). i18n‑сообщения при отказе.
- [ ] Нормализация переноса строк, сохранение базовых метаданных (title/author/lang) в
      `manifest.meta`.
- [ ] Unit‑тесты: PDF с текстом/без текста; превышение лимитов; корректный Manifest.

### 1.3 OCR (PDF/Images)

- [ ] **Tesseract (wasm)** конфиг: `langs[]`, `psm`, `dpi`, `denoise`, `binarize`, таймауты,
      прогресс‑callbacks.
- [ ] Выход: нормализованный текст; _опционально_ bbox‑данные (на будущее, не рендерим сейчас).
- [ ] Batch‑обработка страниц/файлов: ограничение параллельности, отчёт о времени/качества.
- [ ] Unit‑тесты: моки OCR, таймауты/отмена, деградация качества.

### 1.4 Изображения/Clipboard

- [ ] Drag&drop и вставка из Clipboard (image/\*): превью, ограничения форматов `png,jpg,jpeg,webp`
      и `maxFileSizeMB`.
- [ ] Пакет из нескольких изображений → объединяем в один Manifest (с порядком страниц).
- [ ] Ошибки: невалидные форматы/слишком большие файлы → баннеры.

### 1.5 Субтитры (SRT/VTT/ASS)

- [ ] Парсеры: построчно → блоки `{ text, tStart, tEnd }`; нормализация переносов, удаление
      HTML‑тегов.
- [ ] Выбор дорожки/языка (если в файле несколько; VTT/ASS метаданные). Подсказка авто‑детекта.
- [ ] Mapping в `SID` (по порядку) с таймкодами в `manifest.meta.anchors`.
- [ ] Unit‑тесты: edge‑кейсы таймкодов, пустые строки, BOM, шрифт‑метки ASS.

### 1.6 UI/UX Ingestion

- [ ] Единый **диалог импорта**: табы «PDF / Image / Subtitles / Clipboard / Text».
- [ ] Прогресс‑индикаторы (per‑item/overall), отчёт об ошибках/варнингах.
- [ ] Mobile‑first: большие таргеты, отсутствие drag‑only критических операций.
- [ ] i18n‑строки: заголовки, описания лимитов, статусы.

### 1.7 Интеграция с пайплайном

- [ ] Результат Ingestion → сегментация `latvian_sentence_tester` → Manifest/SID → дальнейшая
      обработка (как из Text).
- [ ] Настройки сегментации/лимитов — те же конфиги, без хардкодов.

### 1.8 Документация/конфиги/качество

- [ ] RU‑доки: `/docs/configs/ingestion.*.md` (PDF/OCR/Images/Subtitles), примеры.
- [ ] Zod‑схемы и `validate:config` зелёный.
- [ ] E2E сценарии импорта и последующей обработки.

---

## 2) Спринты

### S14 — Архитектура и конфиги

- IngestionManager, базовые интерфейсы, конфиги и схемы, lazy‑chunks, web‑worker каркас.

### S15 — PDF + OCR fallback

- Извлечение текста из PDF, fallback на OCR, лимиты и сообщения, unit‑тесты.

### S16 — Images/Clipboard → OCR

- DnD/Clipboard, пачка изображений, прогресс, ошибки, unit‑тесты OCR‑потока.

### S17 — Subtitles (SRT/VTT/ASS)

- Парсеры, выбор дорожки/языка, mapping в SID, unit‑тесты.

### S18 — UI/UX и интеграция

- Диалог импорта, прогресс, i18n; связка с сегментацией → общий pipeline; E2E.

### S19 — Docs & Polish

- RU‑доки, шлифовка конфигов/валидаторов, производительность (параллельность OCR), итоговые E2E.

---

## 3) Definition of Done (DoD)

- Любой из источников (PDF/Image/Clipboard/Subtitles) формирует корректный **Manifest (SID)**.
- PDF с текстовым слоем не отправляется в OCR; отсутствие слоя — надёжный fallback на OCR.
- Ограничения форматов/размеров срабатывают и локализованы.
- Subtitles парсятся с таймкодами и дорожками; мапятся в SID.
- Дальнейшая обработка (сегментация/LLM/batch) работает с импортированным контентом без отличий от
  ручного ввода.
- Документация и конфиги готовы; все тесты зелёные.

---

## 4) Риски и меры

- **Производительность OCR**: web‑workers, ограничение параллельности, индикаторы, отмена задач.
- **Качество OCR**: конфиг PSM/DPI/денойз; опция перезагрузки модели; предупреждения о качестве.
- **Разнородность субтитров**: устойчивые парсеры, tolerant‑mode, логирование проблемных строк.
- **Память/большие файлы**: потоковая обработка/чанкинг, `maxFileSizeMB`, подсказки пользователю.
- **Локализация**: полнота ключей, fallback `en`, RU‑документация конфигов.
