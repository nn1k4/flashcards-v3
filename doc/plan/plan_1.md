# План реализации — Этап 1 (MVP v1)

Связка с ТЗ: TRS v5.0 (§5, §6, §7, §8, §9, §10, §11, §12, §16–§18, §20 — «MVP (v1)»).

## 0) Принципы и границы MVP

- Пользовательские режимы: **Text → Flashcards → Reading → Translation → Edit**.
- Поддержка **одиночной** обработки и **переключаемого batch‑режима** (без JSONL‑импорта; он во
  v1.1).
- **Import/Export JSON** (полный снимок состояния, с правками).
- **i18n** (RU/EN как минимум), **themes** (light/dark/system).
- **Конфиги‑first**: все параметры из конфигов; валидация Zod; без хардкодов (линт‑правило +
  скрипт).
- Ошибки и статусы — **баннеры в UI** + адаптивный polling.
- Тесты: unit + e2e (Cypress). Линт: eslint с **codeframe**.

Не входят: контекстное меню ПКМ, Restore/Undo, JSONL‑импорт, OCR/PDF/Subtitles, Media
follow‑highlight, профили/подписки (переносятся в последующие этапы).

---

## 1) Разделение по трекам и задачи

### 1.1 Инфраструктура и конфиги

- [ ] Структура `/config/*.json` + Zod‑схемы (app, i18n, theme, network, llm, batch, flashcards,
      reading, translation, edit, io).
- [ ] Валидатор конфигов при старте; команда `npm run validate:config`.
- [ ] Скрипт «анти‑хардкод» (`lint:anti-hardcode`) и ESLint с `eslint-formatter-codeframe`.
- [ ] RU‑документация `/docs/configs/*` (назначение ключей, дефолты, примеры).

### 1.2 Backend‑proxy (ESM, Node 24)

- [ ] `/api/health` (готовность/версии/проверка внешней сети).
- [ ] Обёртка Anthropic: `/api/batch/{create,status,result}`, `/api/llm/single`.
- [ ] Политики таймаутов/ретраев/заголовков rate‑limit (respect Retry‑After).
- [ ] Единый формат ошибок: коды 429/413/500/529 + советы.

### 1.3 Pipeline и модель данных

- [ ] Manifest (SID) → Card/Context Stores; нормализация языка перевода (targetLanguage).
- [ ] Сегментация предложений: `latvian_sentence_tester` (**local** модуль).
- [ ] Лимиты: «1 предложение/чанк» и «~300 токенов» — конфиг.
- [ ] LLMAdapter (Anthropic): одиночная обработка; BatchAdapter (создание/статус/результат).

### 1.4 UI: Text

- [ ] Поле ввода (лимит из конфига), кнопка **Очистить**.
- [ ] Переключатель **Использовать пакетную обработку** — меняет текст кнопки на «Начать пакетную
      обработку».
- [ ] При включённой галочке — форма «Получить результаты batch»: `batch_id`, Загрузить, история с
      пометкой **просрочено** (≥29 дней).
- [ ] Pre‑flight `/api/health` перед любым стартом/загрузкой.

### 1.5 UI: Flashcards

- [ ] Карточки: front/back, контексты (N по умолчанию, «показать больше» до M — из конфигов).
- [ ] Хоткеи: ←/→ (навигация), Space/↑/↓ (flip), `h` (скрыть карточку).
- [ ] Подсветка целевой формы в контекстах; всегда начинать показ **с front** при навигации.
- [ ] Стили/шрифт/анимация flip — из конфигов (Noto Sans Display по умолчанию).
- [ ] Политика видимости: `all-visible` (дефолт); флаги и события в Store.

### 1.6 UI: Reading

- [ ] Подсветка слов (A) и фраз (B) с легендой; при пересечении — приоритет фразы.
- [ ] Tooltip: surface‑форма, позиционирование внутри viewport; мобильный popover/bottom‑sheet.
- [ ] Производительность: `tooltip.showDelayMs` (дефолт 0), `debounce`, `cancelOnLeave`,
      **single‑flight**.

### 1.7 UI: Translation

- [ ] Панель перевода; статистика: слова (UAX‑29), символы (графемы), предложения (по SID), фразы
      (unique|occurrences) — настройки из конфига.

### 1.8 UI: Edit

- [ ] Таблица карточек: пагинация (`pageSize`), поиск по базовой форме/переводу (опц.: по
      контекстам).
- [ ] Чекбокс **VISIBLE** + **Master Visible** (для всех/фильтра).
- [ ] Изменение **базового перевода** и **переводов контекстов**; моментальная пропагация в
      Flashcards/Reading/Translation.
- [ ] Ссылка «править контексты (N)» (модал/таблица). **Clear** — только в хедере.

### 1.9 Import/Export JSON

- [ ] Экспорт полного состояния (с правками) + метаданные
      `appVersion/schemaVersion/exportedAt/locale/targetLanguage`.
- [ ] Импорт: превью изменений и стратегии `replace-all | merge-keep-local | merge-prefer-imported`
      (дефолт — из конфига).
- [ ] Отчёты о конфликте/ошибках (локализованные баннеры).

### 1.10 i18n/Themes

- [ ] `/locales/{ru,uk,en}.json` (как минимум ru/en — MVP), переключение языка.
- [ ] Тема: light/dark/system; уважение `prefers-color-scheme`.

### 1.11 Ошибки/баннеры/статусы

- [ ] Баннеры при: прокси down, нет сети, 429/413/500/529, expired batch, превышение размеров.
- [ ] Адаптивный polling фронта (1–2с → 3–5с → 10–30с → 30–60с) + jitter; respect Retry‑After.

### 1.12 Тестирование/качество

- [ ] Unit: подсчёт статистик, tooltip‑контроллер, reducers Stores, мерж JSON, анти‑хардкод.
- [ ] E2E (Cypress): основной happy‑path всех режимов; ошибки сети/прокси; batch‑история;
      импорт/экспорт.
- [ ] CI‑скрипты: `lint`, `test`, `build`, `validate:config`.

---

## 2) Скелет спринтов (последовательность работ)

### S0 — Подготовка

- Конфиги + Zod, анти‑хардкод, ESLint codeframe, базовая i18n/theming, заготовки Stores.

### S1 — Proxy & Health & Ошибки

- ESM‑прокси, `/api/health`, единый формат ошибок, баннеры, адаптивный polling.

### S2 — Pipeline Core

- Manifest/SID, сегментация `latvian_sentence_tester`, LLMAdapter (single), BatchAdapter
  (create/status/result), Text UI с переключателем batch.

### S3 — Flashcards v1

- Рендер карточек, контексты N/M, хоткеи, скрытие `h`, стили/flip.

### S4 — Reading v1

- Подсветка слов/фраз, tooltip (delay/debounce/cancel/single‑flight), приоритет фраз,
  позиционирование.

### S5 — Translation v1

- Текст перевода + статистики (UAX‑29/графемы/SID/фразы).

### S6 — Edit v1

- Таблица, поиск, VISIBLE + Master Visible, правка базового перевода/контекстов, пропагация,
  «править контексты (N)», Clear в хедере.

### S7 — Import/Export JSON

- Экспорт/импорт, превью и стратегии merge, отчёты об ошибках.

### S8 — QA‑пакет

- Unit + E2E, перф‑пасс (виртуализация списков при необходимости), документация конфигов.

---

## 3) Definition of Done (DoD)

- Все параметры читаются из конфигов; Zod‑валидация зелёная; нет хардкодов по линту.
- Баннеры ошибок отображаются **моментально**; polling уважает Retry‑After.
- Flashcards/Reading/Translation/Edit — соответствуют Acceptance из ТЗ;
  навигация/хоткеи/контексты/подсветка/позиционирование работают.
- Импорт/экспорт JSON: ре‑импорт экспортированного снапшота восстанавливает **идентичное
  состояние**.
- Покрытие тестами: unit критичных функций и E2E happy‑path + ошибки сети/прокси.
- RU‑документация для конфигов (минимальный набор) готова.

---

## 4) Риски и смягчение

- **Стабильность batches**: придерживаться TechnicalGuidesForClaudeAPI v2.0; заглушки при перегрузе
  (529), бэкофф.
- **Производительность Reading**: включаемая задержка tooltip + single‑flight; ограничение
  параллелизма.
- **i18n расширение**: ранняя декомпозиция строк и ключей; программы миграции словарей.
- **Согласованность Stores**: централизованные события и мемоизированные селекторы.

---

## 5) Артефакты

- Диаграмма модулей (Mermaid) в `/docs/architecture.mmd` (обновить после S2).
- Шаблоны PR‑чеклиста с DoD и ссылкой на соответствующие пункты ТЗ.
